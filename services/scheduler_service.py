from aiogram import Bot
import asyncio
import logging
import random
from datetime import datetime, time, timedelta
from typing import Dict
from aiogram.exceptions import TelegramBadRequest

logger = logging.getLogger(__name__)

MESSAGE_TEMPLATES = {
    "morning_greeting": """–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ vadirss.ru ‚Äî –Ω–∞—à –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ–≥–æ–¥–Ω—è. –í—ã —Å—Ç–∞–ª–∏ —á–∞—Å—Ç—å—é —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–≤, –∏ –º—ã —Ä–∞–¥—ã, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–≤—ã–º–∏, –∫—Ç–æ –æ—Ü–µ–Ω–∏—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞. üéâ

–°–µ–≥–æ–¥–Ω—è —É–∂–µ —Å–µ—Ä–µ–¥–∏–Ω–∞ –¥–Ω—è, –∏ –º—ã —Ö–æ—Ç–µ–ª–∏ –±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏, —Å–∏–ª –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10.

–ú—ã –Ω–∞–¥–µ–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–æ–π–¥–µ—Ç –¥–ª—è –≤–∞—Å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —É—á–∞—Å—Ç–∏–µ! üí´

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "training_reminder": """–£–≤–∞–∂–∞–µ–º—ã–µ —Ñ—É—Ç–±–æ–ª–∏—Å—Ç—ã!

–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —É –≤–∞—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å 22:00 –¥–æ 23:00. –û–±—â–∏–π —Å–±–æ—Ä –≤ 21:30. –ü—Ä–æ—Å–∏–º –≤–∞—Å –Ω–µ –æ–ø–∞–∑–¥—ã–≤–∞—Ç—å –∏ –ø—Ä–∏–µ–∑–∂–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ, —É—á–∏—Ç—ã–≤–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö. üöó

–°–µ–≥–æ–¥–Ω—è –ø—è—Ç–Ω–∏—Ü–∞, –≤–µ—á–µ—Ä, –∏ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–æ—Å—Ç—ã–º–∏: –∑–∏–º–∞, –ø–µ—Ä–µ–ø–∞–¥—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –¥–æ—Ä–æ–∂–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏ –º–∞—Ä—à—Ä—É—Ç, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –≤–ø—É—Å—Ç—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. üí™

–ñ–¥–µ–º –≤–∞—Å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ! –£–¥–∞—á–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã! üåü

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "challenge_1": """–í–Ω–∏–º–∞–Ω–∏–µ! –ù–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂! üöÄ

–°–µ–≥–æ–¥–Ω—è —É –≤–∞—Å –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ –∫–∞–∫ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, —Ç–∞–∫ –∏ –≤ –∫–æ–º–∞–Ω–¥–µ. –ß–µ–ª–ª–µ–Ω–¥–∂–∏ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —ç—Ç–æ —Å–ø–æ—Å–æ–± –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —É–∑–Ω–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –æ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö —Ç–æ–≤–∞—Ä–∏—â–∞—Ö –ø–æ –∫–æ–º–∞–Ω–¥–µ. üí™

–í–æ—Ç –≤–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–°–µ–≥–æ–¥–Ω—è –í–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –æ–±—â—É—é —Ä–∞–∑–º–∏–Ω–∫—É, —á—Ç–æ–±—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤—Å—é –∫–æ–º–∞–Ω–¥—É –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã. üèÉ‚ôÇÔ∏è

–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –≤—ã–∑–æ–≤—ã –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –ª—É—á—à–µ —Å –∫–∞–∂–¥—ã–º –¥–Ω–µ–º! –£–¥–∞—á–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ! üöÄ

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "challenge_2": """–í–Ω–∏–º–∞–Ω–∏–µ! –ù–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂! üöÄ

–°–µ–≥–æ–¥–Ω—è —É –≤–∞—Å –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ –∫–∞–∫ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, —Ç–∞–∫ –∏ –≤ –∫–æ–º–∞–Ω–¥–µ. –ß–µ–ª–ª–µ–Ω–¥–∂–∏ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —ç—Ç–æ —Å–ø–æ—Å–æ–± –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —É–∑–Ω–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –æ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö —Ç–æ–≤–∞—Ä–∏—â–∞—Ö –ø–æ –∫–æ–º–∞–Ω–¥–∞. üí™

–í–æ—Ç –≤–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–°–æ–±–µ—Ä–∏—Ç–µ—Å—å –≤ –∫—Ä—É–≥ –∏ –Ω–∞–ø–æ–º–Ω–∏—Ç–µ —Å–æ–∫–æ–º–∞–Ω–¥–Ω–∏–∫–∞–º –∑–∞—á–µ–º –≤—ã –∑–¥–µ—Å—å. –ó–∞—Ä—è–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ –ø–ª–æ–¥–æ—Ç–≤–æ—Ä–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ü§ù

–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –≤—ã–∑–æ–≤—ã –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –ª—É—á—à–µ —Å –∫–∞–∂–¥—ã–º –¥–Ω–µ–º! –£–¥–∞—á–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ! üöÄ

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "challenge_3": """–í–Ω–∏–º–∞–Ω–∏–µ! –ù–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂! üöÄ

–°–µ–≥–æ–¥–Ω—è —É –≤–∞—Å –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ –∫–∞–∫ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, —Ç–∞–∫ –∏ –≤ –∫–æ–º–∞–Ω–¥–µ. –ß–µ–ª–ª–µ–Ω–¥–∂–∏ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —ç—Ç–æ —Å–ø–æ—Å–æ–± –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —É–∑–Ω–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –æ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö —Ç–æ–≤–∞—Ä–∏—â–∞—Ö –ø–æ –∫–æ–º–∞–Ω–¥–µ. üí™

–í–æ—Ç –≤–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:

–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –≤–µ—Ä–Ω—ã–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω! –û–∫–∞–∂–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–≤–æ–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º, –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –∏—Ö –Ω–µ—É–¥–∞—á–∏.

–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ —É–∫—Ä–µ–ø–∏—Ç—å —Å–≤—è–∑–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–∞–Ω–¥—ã.

–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –≤—ã–∑–æ–≤—ã –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –ª—É—á—à–µ —Å –∫–∞–∂–¥—ã–º –¥–Ω–µ–º! –£–¥–∞—á–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ! üöÄ

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "evening_summary": """–í–æ—Ç –∏ –≤—Å–µ! ü§ùüèª

–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –ø–æ–¥–æ—à–µ–ª –∫ –∫–æ–Ω—Ü—É, –∏ –º—ã —Ö–æ—Ç–∏–º —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –ø—Ä–æ—à–ª–∞ –≤–∞—à–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞. üèÉ‚ôÇÔ∏è

–ü–æ–ª—É—á–∏–ª–∞—Å—å –ª–∏ —É –í–∞—Å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂?

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫""",

    "feedback_request": """–ï–°–õ–ò –•–û–¢–ò–¢–ï –í–´–°–ö–ê–ó–ê–¢–¨–°–Ø:

–ñ–¥–µ–º –≤–∞—à–∏—Ö –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ:

–ö–∞–∫ –≤–∞–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞? –ß—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, –∞ —á—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–¥–µ–ª–∞—Ç—å –ª—É—á—à–µ? ü§î

–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∫–æ–º–∞–Ω–¥–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ? –ë—ã–ª–∏ –ª–∏ –º–æ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏–ª–æ –±—ã —É–ª—É—á—à–∏—Ç—å? ü§ù

–ö–∞–∫–æ–µ —É –≤–∞—Å –æ–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏? –ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã?

–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ üëáüèªüëáüèªüëáüèª

–í–∞—à –ü—Ä–æ—Ñ—Ñ–ü–æ–º–æ—â–Ω–∏–∫"""
}



'''
class TournamentScheduler:
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤"""
    
    TOURNAMENT_SCHEDULE = [
        {
            "time": time(14, 0),  # 14:00
            "name": "14:00 - –ü–µ—Ä–≤—ã–π –æ–ø—Ä–æ—Å: –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ",
            "questions": [
                "–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–±—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏? üí™",
                "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞ —ç–Ω–µ—Ä–≥–∏–∏ —Å–µ–≥–æ–¥–Ω—è —É—Ç—Ä–æ–º? ‚ö°Ô∏è",
                "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–≤–æ–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ç—É—Ä–Ω–∏—Ä–æ–º? üèÉ‚Äç‚ôÇÔ∏è"
            ],
            "callback": "tournament_poll_1",
            "poll_id": 1
        },
        {
            "time": time(15, 0),  # 15:00
            "name": "15:00 - –í—Ç–æ—Ä–æ–π –æ–ø—Ä–æ—Å: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å",
            "questions": [
                "–ì–æ—Ç–æ–≤—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —á–µ–ª–ª–µ–Ω–¥–∂–µ –±–ª–∏—Ü-—Ç—É—Ä–Ω–∏—Ä–∞? üî•",
                "–ù–∞—Å–∫–æ–ª—å–∫–æ –≤—ã –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Ç—É—Ä–Ω–∏—Ä–µ? üéØ",
                "–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—é? ‚öΩ"
            ],
            "callback": "tournament_poll_2",
            "poll_id": 2
        },
        {
            "time": time(17, 0),  # 17:00
            "name": "17:00 - –¢—Ä–µ—Ç–∏–π –æ–ø—Ä–æ—Å: –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º",
            "questions": [
                "–ü–æ—è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ª–µ–≥–∫–æ–µ –≤–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç—É—Ä–Ω–∏—Ä–∞? üò≥",
                "–ö–∞–∫–æ–µ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º? ü§î",
                "–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–µ–¥—Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –≤–æ–ª–Ω–µ–Ω–∏–µ? üå™Ô∏è"
            ],
            "callback": "tournament_poll_3",
            "poll_id": 3
        },
        {
            "time": time(19, 0),  # 19:00
            "name": "19:00 - –ß–µ—Ç–≤–µ—Ä—Ç—ã–π –æ–ø—Ä–æ—Å: –ò—Ç–æ–≥–∏ —Ç—É—Ä–∞",
            "questions": [
                "–£–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è? ‚úÖ",
                "–î–æ–≤–æ–ª—å–Ω—ã –ª–∏ –≤—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–µ—Ä–≤–æ–≥–æ —Ç—É—Ä–∞? üìä",
                "–ö–∞–∫ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–≤–æ—é –∏–≥—Ä—É –≤ –ø–µ—Ä–≤–æ–º —Ç—É—Ä–µ? ‚≠ê"
            ],
            "callback": "tournament_poll_4",
            "poll_id": 4
        },
        {
            "time": time(21, 0),  # 21:00
            "name": "21:00 - –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å: –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è",
            "questions": [
                "–ö–∞–∫–∏–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ—Å—Ç–∞–ª–∏—Å—å –æ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞? üåü",
                "–û—Å—Ç–∞–ª–∏—Å—å –¥–æ–≤–æ–ª—å–Ω—ã —Å–≤–æ–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏? üèÜ",
                "–ß—Ç–æ —Å–∫–∞–∂–µ—Ç–µ –æ —Å–≤–æ–µ–π –∏–≥—Ä–µ? ‚úçÔ∏è",
                "–ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤ —Ç—É—Ä–Ω–∏—Ä–µ? ‚ù§Ô∏è",
                "–ß—Ç–æ –±—ã –≤—ã —É–ª—É—á—à–∏–ª–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑? üîß"
            ],
            "callback": "tournament_poll_5",
            "poll_id": 5
        }
    ]
    
    def __init__(self, bot: Bot):
        self.bot = bot
        self.is_running = False
        self.sent_polls_today = set()
        logger.info("‚úÖ TournamentScheduler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    async def start(self):
        """–ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤"""
        self.is_running = True
        logger.info("üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –∑–∞–ø—É—â–µ–Ω")
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
        await self._reset_daily_polls_if_needed()
        
        while self.is_running:
            try:
                await self._check_and_send_tournament_polls()
                await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                
                # –ö–∞–∂–¥—ã–π —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–±—Ä–æ—Å –¥–Ω–µ–≤–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤
                if datetime.now().minute == 0:
                    await self._reset_daily_polls_if_needed()
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤: {e}")
                await asyncio.sleep(60)
    
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        self.is_running = False
        logger.info("‚èπÔ∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    async def _reset_daily_polls_if_needed(self):
        """–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω–∞—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –¥–µ–Ω—å"""
        now = datetime.now()
        if now.hour == 0 and now.minute == 0:
            self.sent_polls_today.clear()
            logger.info("üóìÔ∏è –°–±—Ä–æ—à–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å")
    
    async def _check_and_send_tournament_polls(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        now = datetime.now()
        current_time = now.time()
        
        for schedule in self.TOURNAMENT_SCHEDULE:
            if (current_time.hour == schedule["time"].hour and 
                current_time.minute == schedule["time"].minute):
                
                if schedule["poll_id"] in self.sent_polls_today:
                    logger.info(f"–û–ø—Ä–æ—Å #{schedule['poll_id']} —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–µ–≥–æ–¥–Ω—è")
                    continue
                
                random_question = random.choice(schedule["questions"])
                
                message_text = (
                    f"üéØ –¢–£–†–ù–ò–†–ù–´–ô –û–ü–†–û–°\n\n"
                    f"üïê {schedule['name']}\n\n"
                    f"{random_question}\n\n"
                    f"‚û°Ô∏è –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å: /{schedule['callback']}"
                )
                
                # ===== –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º =====
                sent_count = await self._broadcast_to_all_users(message_text)
                
                if sent_count > 0:
                    self.sent_polls_today.add(schedule["poll_id"])
                    logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç—É—Ä–Ω–∏—Ä–Ω—ã–π –æ–ø—Ä–æ—Å #{schedule['poll_id']} "
                               f"({sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)")
                else:
                    logger.warning(f"‚ö†Ô∏è –û–ø—Ä–æ—Å #{schedule['poll_id']} –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∏–∫–æ–º—É")
                
                break
    
    async def _broadcast_to_all_users(self, message: str) -> int:
        """–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        from database import get_session, User
        
        session = get_session()
        sent_count = 0
        failed_count = 0
        
        try:
            users = session.query(User).filter(
                User.chat_id.isnot(None)
            ).all()
            
            if not users:
                logger.warning("‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
                return 0
            
            logger.info(f"üì¢ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            
            for user in users:
                try:
                    await self.bot.send_message(
                        chat_id=user.chat_id,
                        text=message,
                        parse_mode=None  # –ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    )
                    sent_count += 1
                    
                    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (–Ω–µ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ)
                    if sent_count % 20 == 0:
                        await asyncio.sleep(1)
                    elif sent_count % 5 == 0:
                        await asyncio.sleep(0.2)
                    
                except TelegramBadRequest as e:
                    if "chat not found" in str(e) or "user is deactivated" in str(e):
                        logger.warning(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.user_id} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {user.chat_id}")
                    else:
                        logger.warning(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.user_id}: {e}")
                    failed_count += 1
                except Exception as e:
                    logger.warning(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.user_id}: {e}")
                    failed_count += 1
            
            logger.info(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏: ‚úÖ {sent_count} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ‚ùå {failed_count} –æ—à–∏–±–æ–∫")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        finally:
            session.close()
        
        return sent_count
    
    # ===== –ú–ï–¢–û–î–´ –î–õ–Ø –ê–î–ú–ò–ù–ê =====
    
    async def send_test_poll(self, chat_id: int, poll_type: str = None) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –æ–ø—Ä–æ—Å –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π —á–∞—Ç (–¥–ª—è –∞–¥–º–∏–Ω–∞)"""
        try:
            if not poll_type or poll_type == "random":
                schedule = random.choice(self.TOURNAMENT_SCHEDULE)
            else:
                poll_map = {
                    "1": self.TOURNAMENT_SCHEDULE[0],
                    "2": self.TOURNAMENT_SCHEDULE[1],
                    "3": self.TOURNAMENT_SCHEDULE[2],
                    "4": self.TOURNAMENT_SCHEDULE[3],
                    "5": self.TOURNAMENT_SCHEDULE[4],
                }
                schedule = poll_map.get(poll_type, self.TOURNAMENT_SCHEDULE[0])
            
            random_question = random.choice(schedule["questions"])
            
            message_text = (
                f"üéØ –¢–ï–°–¢–û–í–´–ô –¢–£–†–ù–ò–†–ù–´–ô –û–ü–†–û–°\n\n"
                f"üïê {schedule['name']}\n\n"
                f"{random_question}\n\n"
                f"‚û°Ô∏è –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å: /{schedule['callback']}"
            )
            
            await self.bot.send_message(
                chat_id=chat_id,
                text=message_text,
                parse_mode=None
            )
            
            logger.info(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –æ–ø—Ä–æ—Å #{schedule['poll_id']} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç {chat_id}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–ø—Ä–æ—Å–∞: {e}")
            return False
    
    async def broadcast_all_polls_now(self) -> Dict[str, int]:
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–°–ï —Ç—É—Ä–Ω–∏—Ä–Ω—ã–µ –æ–ø—Ä–æ—Å—ã –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–µ–π—á–∞—Å"""
        from database import get_session, User
        
        session = get_session()
        results = {"total_sent": 0, "total_users": 0}
        
        try:
            users = session.query(User).filter(
                User.chat_id.isnot(None)
            ).all()
            
            if not users:
                logger.warning("‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
                return results
            
            results["total_users"] = len(users)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ 5 –æ–ø—Ä–æ—Å–æ–≤
            for schedule in self.TOURNAMENT_SCHEDULE:
                random_question = random.choice(schedule["questions"])
                
                message_text = (
                    f"üéØ –¢–£–†–ù–ò–†–ù–´–ô –û–ü–†–û–° #{schedule['poll_id']}\n\n"
                    f"üïê {schedule['name']}\n\n"
                    f"{random_question}\n\n"
                    f"‚û°Ô∏è –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å: /{schedule['callback']}"
                )
                
                poll_sent_count = 0
                
                for user in users:
                    try:
                        await self.bot.send_message(
                            chat_id=user.chat_id,
                            text=message_text,
                            parse_mode=None
                        )
                        poll_sent_count += 1
                        results["total_sent"] += 1
                        
                        if poll_sent_count % 10 == 0:
                            await asyncio.sleep(0.5)
                        
                    except Exception as e:
                        continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                
                logger.info(f"‚úÖ –û–ø—Ä–æ—Å #{schedule['poll_id']} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {poll_sent_count}/{len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")
                await asyncio.sleep(2)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –æ–ø—Ä–æ—Å–∞–º–∏
            
            logger.info(f"‚úÖ –í—Å–µ –æ–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫: {results['total_sent']}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏: {e}")
        finally:
            session.close()
        
        return results
    
    def get_schedule_info(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏"""
        info = "üìÖ –†–ê–°–ü–ò–°–ê–ù–ò–ï –¢–£–†–ù–ò–†–ù–´–• –û–ü–†–û–°–û–í\n\n"
        
        for schedule in self.TOURNAMENT_SCHEDULE:
            time_str = schedule["time"].strftime("%H:%M")
            questions_count = len(schedule["questions"])
            sent_today = "‚úÖ" if schedule["poll_id"] in self.sent_polls_today else "‚è≥"
            
            info += (
                f"{sent_today} {time_str} - {schedule['name']}\n"
                f"   üìù –í–æ–ø—Ä–æ—Å–æ–≤: {questions_count} | –ö–æ–º–∞–Ω–¥–∞: /{schedule['callback']}\n\n"
            )
        
        info += f"üìä –°–µ–≥–æ–¥–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {len(self.sent_polls_today)}/{len(self.TOURNAMENT_SCHEDULE)} –æ–ø—Ä–æ—Å–æ–≤"
        return info
    
    async def reset_today_polls(self):
        """–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –æ–ø—Ä–æ—Å—ã"""
        self.sent_polls_today.clear()
        logger.info("üîÑ –°—Ç–∞—Ç—É—Å—ã —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ —Å–±—Ä–æ—à–µ–Ω—ã")

class SchedulerManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞–º–∏"""
    
    def __init__(self, bot: Bot):
        self.bot = bot
        self.tournament_scheduler = TournamentScheduler(bot)
        self.active_schedulers = []
        
    def start(self):
        """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤"""
        logger.info("‚úÖ SchedulerManager –∑–∞–ø—É—â–µ–Ω")
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏
        return self
        
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤"""
        logger.info("‚èπÔ∏è SchedulerManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω") '''