import logging
from typing import Dict, List, Optional, Tuple
from datetime import datetime, timedelta
from database import get_session, User, Survey
from services.ai_service import AIService
import json

logger = logging.getLogger(__name__)

class ProffKonstaltingMetrics:
    """–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º ProffKonstalting"""

    def __init__(self):
        self.ai_service = AIService()
        self.metrics_definitions = {
            "internal_motivation": {
                "name": "–£—Ä–æ–≤–µ–Ω—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏",
                "description": "–û—Ü–µ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                "scale": [1, 2, 3, 4, 5],
                "labels": {
                    1: "–ù–µ–∑–¥–æ—Ä–æ–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ (–°—Ç—Ä–∞—Å—Ç—å –∫ –ø–æ–±–µ–¥–µ) ‚Äî –º–æ—Ç–∏–≤–∞—Ü–∏—è –ø–æ–±–µ–¥—ã –ª—é–±–æ–π —Ü–µ–Ω–æ–π",
                    2: "–ñ–µ–ª–∞–Ω–∏–µ —Å–ª–∞–≤—ã ‚Äî —á–µ–ª–æ–≤–µ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ø–∞—Å—Ç—å—Å—è –≤ —Ü–µ–Ω—Ç—Ä –≤–Ω–∏–º–∞–Ω–∏—è",
                    3: "–°—Ç—Ä–∞—Ö",
                    4: "–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞",
                    5: "–ñ–µ–ª–∞–Ω–∏–µ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –Ω–æ–≤–æ–º—É"
                },
                "vip": True
            },
            "team_impact": {
                "name": "–ò–Ω–¥–µ–∫—Å –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è",
                "description": "–í–ª–∏—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–æ–º–∞–Ω–¥—É",
                "scale": [1, 2, 3, 4],
                "labels": {
                    1: "–ù–µ–ø—Ä–∏–Ω—è—Ç–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏, –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É",
                    2: "–ü–æ–ª–Ω–æ–µ —Å–º–∏—Ä–µ–Ω–∏–µ, –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è",
                    3: "–ù–µ—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ –∫–æ–º–∞–Ω–¥—É, –µ—Å—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–µ–±—è (–ø–æ–¥–Ω—è—Ç–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –∂–µ–ª–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é)",
                    4: "–õ–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞, –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–∞–Ω–¥–µ"
                },
                "vip": True
            },
            "mentoring_coefficient": {
                "name": "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞",
                "description": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤—É",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–µ–ø—Ä–∏–Ω—è—Ç–∏–µ, –æ—Ç—Ç–æ—Ä–∂–µ–Ω–∏–µ (–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ –Ω–µ–∂–µ–ª–∞–Ω–∏–µ –ø—Ä–æ—è–≤–ª—è—Ç—å –∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ)",
                    2: "–ë–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ–µ (—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–ª—É—à–∞—Ç—å, –Ω–æ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ)",
                    3: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–ª—É—à–∞—Ç—å, –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å, –≥–æ–≤–æ—Ä–∏—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å)"
                },
                "vip": True
            },
            "professional_values": {
                "name": "–ü—Ä–æ—Ñ—Ñ—Ü–µ–Ω–Ω–æ—Å—Ç–∏",
                "description": "–ë–ª–∏–∑–æ—Å—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–º–ø–∞–Ω–∏–∏",
                "scale": [0, 100],  # percentage
                "calculation": "interaction_based",
                "vip": False
            },
            "emotional_intelligence": {
                "name": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
                "description": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å —ç–º–æ—Ü–∏—è–º–∏",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å EQ, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —ç–º–æ—Ü–∏—è–º–∏",
                    2: "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å EQ, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏, –Ω–æ —Å —Ç—Ä—É–¥–æ–º —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º–∏",
                    3: "–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å EQ, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∏ —á—É–∂–∏–º–∏ —ç–º–æ—Ü–∏—è–º–∏"
                },
                "vip": True
            },
            "stress_resilience": {
                "name": "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
                "description": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∞—è —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –≤—ã–≥–æ—Ä–∞–Ω–∏—é",
                    2: "–°—Ä–µ–¥–Ω—è—è —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º —Å—Ç—Ä–µ—Å—Å–æ–º",
                    3: "–í—ã—Å–æ–∫–∞—è —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º —Å—Ç—Ä–µ—Å—Å–∞"
                },
                "vip": False
            },
            "responsibility": {
                "name": "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
                "description": "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤–∏–Ω—É –Ω–∞ –¥—Ä—É–≥–∏—Ö",
                    2: "–°—Ä–µ–¥–Ω—è—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å —Å–≤–æ–∏ –æ—à–∏–±–∫–∏",
                    3: "–í—ã—Å–æ–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è –∏ –∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è"
                },
                "vip": False
            },
            "communication_skills": {
                "name": "–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏",
                "description": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—â–∞—Ç—å—Å—è",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –æ–±—â–µ–Ω–∏–∏",
                    2: "–°—Ä–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–∞–∑–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ",
                    3: "–í—ã—Å–æ–∫–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏ —É–±–µ–∂–¥–∞—Ç—å"
                },
                "vip": False
            },
            "adaptability": {
                "name": "–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å",
                "description": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º",
                    2: "–°—Ä–µ–¥–Ω—è—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ —É–º–µ—Ä–µ–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º",
                    3: "–í—ã—Å–æ–∫–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –ª—é–±—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º"
                },
                "vip": False
            },
            "learning_ability": {
                "name": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é",
                "description": "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ–±—É—á–∞—Ç—å—Å—è –Ω–æ–≤–æ–º—É",
                "scale": [1, 2, 3],
                "labels": {
                    1: "–ù–∏–∑–∫–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é",
                    2: "–°—Ä–µ–¥–Ω—è—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é",
                    3: "–í—ã—Å–æ–∫–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é"
                },
                "vip": False
            }
        }

        # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–µ
        self.survey_questions = {
            "internal_motivation": [
                "–ß—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤ —Ä–∞–±–æ—Ç–µ?",
                "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è–º –∏ –∫–æ–Ω–∫—É—Ä—Å–∞–º?",
                "–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å?",
                "–ì–æ—Ç–æ–≤—ã –ª–∏ –≤—ã –∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å –ª–∏—á–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º —Ä–∞–¥–∏ –ø–æ–±–µ–¥—ã?"
            ],
            "team_impact": [
                "–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –Ω–∞ –Ω–µ—É–¥–∞—á–∏ –∫–æ–º–∞–Ω–¥—ã?",
                "–ë–µ—Ä–µ—Ç–µ –ª–∏ –≤—ã –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö?",
                "–ö–∞–∫ –≤—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç–µ –∫–æ–ª–ª–µ–≥ –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã?",
                "–í–ª–∏—è–µ—Ç–µ –ª–∏ –≤—ã –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã?"
            ],
            "mentoring_coefficient": [
                "–ì–æ—Ç–æ–≤—ã –ª–∏ –≤—ã –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º —Å –∫–æ–ª–ª–µ–≥–∞–º–∏?",
                "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —Å–æ–≤–µ—Ç–∞–º –æ—Ç –¥—Ä—É–≥–∏—Ö?",
                "–ü–æ–º–æ–≥–∞–µ—Ç–µ –ª–∏ –≤—ã –Ω–æ–≤–∏—á–∫–∞–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è?",
                "–ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –≤—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—É—é –∫—Ä–∏—Ç–∏–∫—É?"
            ],
            "emotional_intelligence": [
                "–õ–µ–≥–∫–æ –ª–∏ –≤—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç–µ —ç–º–æ—Ü–∏–∏ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π?",
                "–ú–æ–∂–µ—Ç–µ –ª–∏ –≤—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏ –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö?",
                "–ü–æ–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏—á–∏–Ω—ã —á—É–∂–∏—Ö —ç–º–æ—Ü–∏–π?",
                "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ª–∏ –≤—ã —ç–º–æ—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏?"
            ],
            "stress_resilience": [
                "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º —Ä–∞–±–æ—Ç—ã?",
                "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ?",
                "–ö–∞–∫ –≤—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ—Å—å –ø–æ—Å–ª–µ —Å—Ç—Ä–µ—Å—Å–∞?",
                "–ú–æ–∂–µ—Ç–µ –ª–∏ –≤—ã —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º –¥–µ–¥–ª–∞–π–Ω–æ–≤?"
            ],
            "responsibility": [
                "–ë–µ—Ä–µ—Ç–µ –ª–∏ –≤—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –æ—à–∏–±–∫–∏?",
                "–í—ã–ø–æ–ª–Ω—è–µ—Ç–µ –ª–∏ –≤—ã –æ–±–µ—â–∞–Ω–∏—è?",
                "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è–º?",
                "–î–æ–≤–µ—Ä—è—é—Ç –ª–∏ –≤–∞–º –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏?"
            ],
            "communication_skills": [
                "–õ–µ–≥–∫–æ –ª–∏ –≤–∞–º –≤—ã—Ä–∞–∂–∞—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏?",
                "–°–ª—É—à–∞–µ—Ç–µ –ª–∏ –≤—ã –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞?",
                "–ú–æ–∂–µ—Ç–µ –ª–∏ –≤—ã —É–±–µ–∂–¥–∞—Ç—å –¥—Ä—É–≥–∏—Ö –≤ —Å–≤–æ–µ–π —Ç–æ—á–∫–µ –∑—Ä–µ–Ω–∏—è?",
                "–ö–∞–∫ –≤—ã –≤–µ–¥–µ—Ç–µ —Å–µ–±—è –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö?"
            ],
            "adaptability": [
                "–õ–µ–≥–∫–æ –ª–∏ –≤—ã –ø—Ä–∏–≤—ã–∫–∞–µ—Ç–µ –∫ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º?",
                "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º?",
                "–ë—ã—Å—Ç—Ä–æ –ª–∏ –≤—ã –æ—Å–≤–∞–∏–≤–∞–µ—Ç–µ –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã?",
                "–ì–æ—Ç–æ–≤—ã –ª–∏ –≤—ã –º–µ–Ω—è—Ç—å –ø—Ä–∏–≤—ã—á–∫–∏ —Ä–∞–¥–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏?"
            ],
            "learning_ability": [
                "–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã –∏–∑—É—á–∞–µ—Ç–µ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ?",
                "–õ–µ–≥–∫–æ –ª–∏ –≤–∞–º –¥–∞–µ—Ç—Å—è –æ–±—É—á–µ–Ω–∏–µ?",
                "–ü—Ä–∏–º–µ–Ω—è–µ—Ç–µ –ª–∏ –≤—ã –Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?",
                "–ò—â–µ—Ç–µ –ª–∏ –≤—ã –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è?"
            ]
        }

    def calculate_professional_values(self, user_id: int) -> float:
        """–†–∞—Å—á–µ—Ç –ø—Ä–æ—Ñ—Ñ—Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –±–æ—Ç–æ–º"""
        session = get_session()
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
            month_ago = datetime.now() - timedelta(days=30)
            surveys = session.query(Survey).filter(
                Survey.user_id == user_id,
                Survey.created_at >= month_ago
            ).all()

            # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 10 –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –≤ –º–µ—Å—è—Ü
            total_possible_interactions = 10
            actual_interactions = len(surveys)

            percentage = min((actual_interactions / total_possible_interactions) * 100, 100)
            return percentage

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ñ—Ñ—Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
            return 0.0
        finally:
            session.close()

    def analyze_user_responses(self, user_id: int, responses: Dict[str, List[int]]) -> Dict:
        """
        –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫

        responses: —Å–ª–æ–≤–∞—Ä—å —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –ø–æ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–µ
        –§–æ—Ä–º–∞—Ç: {"internal_motivation": [3, 4, 2, 5], "team_impact": [4, 3, 4], ...}
        """
        results = {}

        for metric_key, answers in responses.items():
            if metric_key not in self.metrics_definitions:
                continue

            metric_def = self.metrics_definitions[metric_key]

            if metric_key == "professional_values":
                # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è –ø—Ä–æ—Ñ—Ñ—Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
                score = self.calculate_professional_values(user_id)
            else:
                # –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
                if answers:
                    score = sum(answers) / len(answers)
                    # –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ü–µ–ª–æ–≥–æ –¥–ª—è –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã—Ö —à–∫–∞–ª
                    if metric_def["scale"][-1] <= 5:
                        score = round(score)
                else:
                    score = 1  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            results[metric_key] = {
                "score": score,
                "name": metric_def["name"],
                "description": metric_def["description"],
                "vip": metric_def.get("vip", False),
                "interpretation": self._interpret_score(metric_key, score)
            }

        return results

    def _interpret_score(self, metric_key: str, score: float) -> str:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –±–∞–ª–ª–∞ –ø–æ –º–µ—Ç—Ä–∏–∫–µ"""
        metric_def = self.metrics_definitions[metric_key]

        if metric_key == "professional_values":
            if score >= 80:
                return "–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–º–ø–∞–Ω–∏–∏"
            elif score >= 60:
                return "–•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–º–ø–∞–Ω–∏–∏"
            elif score >= 40:
                return "–°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–º–ø–∞–Ω–∏–∏"
            else:
                return "–ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–º–ø–∞–Ω–∏–∏"

        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º labels
        if "labels" in metric_def:
            rounded_score = round(score)
            if rounded_score in metric_def["labels"]:
                return metric_def["labels"][rounded_score]

        return f"–ë–∞–ª–ª: {score}"

    def generate_personal_recommendations(self, metrics_results: Dict) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫"""
        recommendations = []

        for metric_key, result in metrics_results.items():
            score = result["score"]
            metric_def = self.metrics_definitions[metric_key]

            if metric_key == "internal_motivation":
                if score <= 2:
                    recommendations.append("–†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –∑–¥–æ—Ä–æ–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π - —Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–∏")
                elif score >= 4:
                    recommendations.append("–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º—É —Ä–æ—Å—Ç—É")

            elif metric_key == "team_impact":
                if score <= 2:
                    recommendations.append("–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —É–º–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É")
                elif score >= 3:
                    recommendations.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ –ª–∏–¥–µ—Ä—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–º–æ—â–∏ –∫–æ–ª–ª–µ–≥–∞–º")

            elif metric_key == "emotional_intelligence":
                if score <= 1:
                    recommendations.append("–†–∞–∑–≤–∏–≤–∞–π—Ç–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫—É –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏")
                elif score >= 2:
                    recommendations.append("–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–º–æ—Ü–∏—è–º–∏")

            elif metric_key == "stress_resilience":
                if score <= 1:
                    recommendations.append("–£–ª—É—á—à–∞–π—Ç–µ —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –æ—Ç–¥—ã—Ö –∏ —Å–ø–æ—Ä—Ç")
                elif score >= 2:
                    recommendations.append("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏")

            elif metric_key == "communication_skills":
                if score <= 1:
                    recommendations.append("–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ")
                elif score >= 2:
                    recommendations.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã")

        return recommendations[:5]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

    def get_survey_questions(self, metric_key: str) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–ø—Ä–æ—Å–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–µ—Ç—Ä–∏–∫–µ"""
        return self.survey_questions.get(metric_key, [])

    def get_all_metrics(self) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫"""
        return self.metrics_definitions



    async def generate_ai_questions_based_on_answers(self, user_context: Dict) -> Dict[str, List[str]]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI-–≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏

        user_context: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
        {
            'profile': {
                'name': str,
                'direction': str,
                'sport_type': str,
                'position': str,
                'role': str,
                'level': int
            },
            'answers_by_metric': {
                'metric_key': [
                    {'question': str, 'answer': str, 'survey_id': int, 'date': str},
                    ...
                ],
                ...
            },
            'has_history': bool
        }

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
        """
        ai_questions = {}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ user_context —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º
        if not isinstance(user_context, dict):
            logger.error(f"user_context must be a dict, got {type(user_context)}")
            return {}

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        profile: Dict = user_context.get('profile', {})
        user_name = profile.get('name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
        direction = profile.get('direction', '–Ω–µ —É–∫–∞–∑–∞–Ω')
        position = profile.get('position', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')
        level = profile.get('level', 1)

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç—ã, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º
        answers_by_metric = user_context.get('answers_by_metric', {})
        has_history = user_context.get('has_history', False)

        # –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        if not has_history or not answers_by_metric:
            logger.info("–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
            for metric_key, metric_def in self.metrics_definitions.items():
                if metric_key == "professional_values":
                    continue
                ai_questions[metric_key] = self.survey_questions.get(metric_key, [])[:4]
            return ai_questions

        # –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        all_answers_text = ""
        for metric_key, answers in answers_by_metric.items():
            if answers:
                metric_name = self.metrics_definitions.get(metric_key, {}).get('name', metric_key)
                all_answers_text += f"\n–ú–ï–¢–†–ò–ö–ê: {metric_name}\n"
                for answer_data in answers[-3:]:  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –æ—Ç–≤–µ—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–µ
                    all_answers_text += f"–í–æ–ø—Ä–æ—Å: {answer_data['question']}\n–û—Ç–≤–µ—Ç: {answer_data['answer']}\n"

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
        for metric_key, metric_def in self.metrics_definitions.items():
            if metric_key == "professional_values":
                continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–µ
            metric_answers = answers_by_metric.get(metric_key, [])
            has_metric_history = len(metric_answers) > 0

            # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            if has_metric_history:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–µ
                metric_answers_text = ""
                for answer_data in metric_answers[-2:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –æ—Ç–≤–µ—Ç–∞
                    metric_answers_text += f"–í–æ–ø—Ä–æ—Å: {answer_data['question']}\n–û—Ç–≤–µ—Ç: {answer_data['answer']}\n"

                prompt = f"""
                –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
                –ò–º—è: {user_name}
                –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {direction}
                –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position}
                –£—Ä–æ–≤–µ–Ω—å: {level}

                –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –º–µ—Ç—Ä–∏–∫–µ "{metric_def['name']}" —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π 3-4 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

                –û–ü–ò–°–ê–ù–ò–ï –ú–ï–¢–†–ò–ö–ò: {metric_def['description']}
                –®–ö–ê–õ–ê –û–¶–ï–ù–ö–ò: {', '.join([f"{k}: {v}" for k, v in metric_def['labels'].items()])}

                –ü–†–ï–î–´–î–£–©–ò–ï –û–¢–í–ï–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ü–û –≠–¢–û–ô –ú–ï–¢–†–ò–ö–ï:
                {metric_answers_text}

                –û–ë–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –î–†–£–ì–ò–• –ú–ï–¢–†–ò–ö:
                {all_answers_text}

                –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —à–∫–∞–ª–µ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–∏.
                –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, —É—Ä–æ–≤–µ–Ω—å) –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ –µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
                –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏, –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–º–∏ –∏ –ø–æ–∑–≤–æ–ª—è—Ç—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–∞–ª–ª –ø–æ —à–∫–∞–ª–µ.

                –ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –í–û–ü–†–û–°–û–í:
                - –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏: "–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –≤—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –∑–∞–¥–∞—á–µ–π, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏"
                - –î–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è: "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ –≤—ã –ø–æ–º–æ–≥–ª–∏ –∫–æ–º–∞–Ω–¥–µ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å –∫—Ä–∏–∑–∏—Å"

                –í–ï–†–ù–ò –¢–û–õ–¨–ö–û –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
                """
            else:
                # –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                prompt = f"""
                –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
                –ò–º—è: {user_name}
                –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {direction}
                –î–æ–ª–∂–Ω–æ—Å—Ç—å: {position}
                –£—Ä–æ–≤–µ–Ω—å: {level}

                –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –º–µ—Ç—Ä–∏–∫–µ "{metric_def['name']}", –Ω–æ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ –¥—Ä—É–≥–∏–º –º–µ—Ç—Ä–∏–∫–∞–º.
                –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ –æ–±—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π 3-4 –Ω–∞—á–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–∏.

                –û–ü–ò–°–ê–ù–ò–ï –ú–ï–¢–†–ò–ö–ò: {metric_def['description']}
                –®–ö–ê–õ–ê –û–¶–ï–ù–ö–ò: {', '.join([f"{k}: {v}" for k, v in metric_def['labels'].items()])}

                –û–ë–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –î–†–£–ì–ò–• –ú–ï–¢–†–ò–ö:
                {all_answers_text}

                –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —à–∫–∞–ª–µ —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–∏.
                –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ –µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, —É—Ä–æ–≤–µ–Ω—å).
                –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–º–∏.

                –í–ï–†–ù–ò –¢–û–õ–¨–ö–û –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
                """

            try:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ AIService
                response = await self.ai_service.get_ai_response(prompt)
                logger.info(f"AI response for {metric_key}: {response[:200]}...")

                # –†–∞–∑–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç –≤ —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
                questions = []
                for line in response.split('\n'):
                    line = line.strip()
                    # –£–±–∏—Ä–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –∏ –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤
                    line = line.lstrip(r'1234567890.-\* ')
                    if line and len(line) > 10:  # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–∏
                        questions.append(line)

                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                if not questions:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è {metric_key}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
                    questions = self.survey_questions.get(metric_key, [])[:4]

                ai_questions[metric_key] = questions[:4]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 4 –≤–æ–ø—Ä–æ—Å–æ–≤
                logger.info(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(questions)} –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ {metric_key}")

            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI-–≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ {metric_key}: {e}")
                # Fallback –∫ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º
                ai_questions[metric_key] = self.survey_questions.get(metric_key, [])[:4]

        return ai_questions

    async def score_answers_with_ai(self, user_answers: List[Dict], ai_questions: Dict[str, List[str]]) -> Dict[str, int]:
        """
        –û—Ü–µ–Ω–∫–∞ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞—á–∞–ª—å–Ω—ã—Ö –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö) —Å –ø–æ–º–æ—â—å—é AI –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º

        user_answers: –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞—á–∞–ª—å–Ω—ã–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ) –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
        [{"question": "–≤–æ–ø—Ä–æ—Å", "answer": "–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "timestamp": "..."}, ...]
        ai_questions: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ AI –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –±–∞–ª–ª–∞–º–∏ –ø–æ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–µ (—Ç–æ–ª—å–∫–æ –±–∞–ª–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î, –æ—Ç–≤–µ—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
        """
        scores = {}

        answers_text = "\n".join([f"–í–æ–ø—Ä–æ—Å: {qa['question']}\n–û—Ç–≤–µ—Ç: {qa['answer']}" for qa in user_answers])

        for metric_key, questions in ai_questions.items():
            if metric_key not in self.metrics_definitions:
                continue

            metric_def = self.metrics_definitions[metric_key]

            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ —à–∫–∞–ª–æ–π
            questions_text = "\n".join([f"- {q}" for q in questions])

            prompt = f"""
            –û—Ü–µ–Ω–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –º–µ—Ç—Ä–∏–∫–µ "{metric_def['name']}" –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã.

            –®–ö–ê–õ–ê –û–¶–ï–ù–ö–ò:
            {chr(10).join([f"{k} –±–∞–ª–ª: {v}" for k, v in metric_def['labels'].items()])}

            –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –í–û–ü–†–û–°–´ –î–õ–Ø –û–¶–ï–ù–ö–ò:
            {questions_text}

            –û–¢–í–ï–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
            {answers_text}

            –ù–ê –û–°–ù–û–í–ê–ù–ò–ò –í–°–ï–• –û–¢–í–ï–¢–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –±–∞–ª–ª –ø–æ —à–∫–∞–ª–µ.
            –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω –∏ –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞–π –æ—Ü–µ–Ω–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤.

            –í–ï–†–ù–ò –¢–û–õ–¨–ö–û –¶–ò–§–†–£ –ë–ê–õ–õ–ê (–æ—Ç {min(metric_def['scale'])} –¥–æ {max(metric_def['scale'])}), –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
            """

            try:
                response = await self.ai_service.get_ai_response(prompt)
                logger.info(f"AI scoring response for {metric_key}: {response[:100]}...")

                # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                import re
                score_match = re.search(r'\b(\d+)\b', response.strip())
                if score_match:
                    score = int(score_match.group(1))
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∞–ª–ª –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
                    if score in metric_def['scale']:
                        scores[metric_key] = score
                    else:
                        logger.warning(f"–ë–∞–ª–ª {score} –Ω–µ –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–ª—è {metric_key}, –∏—Å–ø–æ–ª—å–∑—É–µ–º 1")
                        scores[metric_key] = 1  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                else:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –±–∞–ª–ª –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI –¥–ª—è {metric_key}")
                    scores[metric_key] = 1  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ –º–µ—Ç—Ä–∏–∫–∏ {metric_key}: {e}")
                scores[metric_key] = 1  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        return scores

    async def generate_comprehensive_ai_analysis(self, user_context: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        metrics_results = user_context.get('metrics_results', {})
        user_name = user_context.get('name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

        if not metrics_results:
            return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü—Ä–æ–π–¥–∏—Ç–µ –æ–ø—Ä–æ—Å –µ—â–µ —Ä–∞–∑."

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–µ—Ç—Ä–∏–∫
        metrics_text = ""
        for metric_key, result in metrics_results.items():
            metrics_text += f"‚Ä¢ {result['name']}: {result['score']} –±–∞–ª–ª–æ–≤ - {result['interpretation']}\n"

        prompt = f"""
        –¢—ã HR-–∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {user_name} –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–µ—Ç—Ä–∏–∫ ProffKonstalting.

        –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ú–ï–¢–†–ò–ö:
        {metrics_text}

        –°–û–ó–î–ê–ô –ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó –í –°–¢–†–û–ì–û–ú –§–û–†–ú–ê–¢–ï –î–õ–Ø TELEGRAM:

        üéâ –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô AI-–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù!

        *1. –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞*
        [–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ 2-3 –∞–±–∑–∞—Ü–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–ª–ª–æ–≤ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º]

        *2. –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º –º–µ—Ç—Ä–∏–∫–∞–º*
        [–ê–Ω–∞–ª–∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –ª–∏–¥–µ—Ä—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∏ —Ç.–¥. –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –±–∞–ª–ª–æ–≤]

        *3. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 3]

        *4. –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 3]

        *5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 3]

        *6. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏*
        [–û—Ü–µ–Ω–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –≤ 1-2 –∞–±–∑–∞—Ü–∞—Ö]

        üí° –ú–û–¢–ò–í–ê–¶–ò–û–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï
        [–ù–∞–ø–∏—à–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–∫–∞–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≥–¥–µ –µ–º—É —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è (—Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞), –∞ –≥–¥–µ –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è (—Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã). –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω –∏ –ø–æ–æ—â—Ä—è–π —Ä–∞–∑–≤–∏—Ç–∏–µ.]

        –í–ê–ñ–ù–û:
        - –ò—Å–ø–æ–ª—å–∑—É–π *—Ç–µ–∫—Å—Ç* –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∫—É—Ä—Å–∏–≤ –≤ Telegram)
        - –ò—Å–ø–æ–ª—å–∑—É–π ‚Ä¢ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ (–Ω–µ -, —Ç–∞–∫ –∫–∞–∫ - –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Telegram)
        - –ò—Å–ø–æ–ª—å–∑—É–π **—Ç–µ–∫—Å—Ç** –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ (–∂–∏—Ä–Ω—ã–π)
        - –ü–∏—à–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º HR-—è–∑—ã–∫–æ–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
        - –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞–π –≤—ã–≤–æ–¥—ã –±–∞–ª–ª–∞–º–∏
        - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–µ—Ç–∫–æ–π –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º–æ–π –≤ Telegram
        - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö
        - –í –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–¥—á–µ—Ä–∫–Ω–∏, —á—Ç–æ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –º–æ–∂–Ω–æ –Ω–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ, –∞ —Å–ª–∞–±—ã–µ —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è
        """

        try:
            analysis = await self.ai_service.get_ai_response(prompt)
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            analysis = analysis.replace('**', '').replace('__', '').replace('```', '')
            return analysis
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."

    async def generate_ai_analysis(self, user_name: str, metrics_results: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI-–∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        prompt = f"""
        –¢—ã HR-–∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {user_name} –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫ ProffKonstalting.

        –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ú–ï–¢–†–ò–ö:
        {chr(10).join([f"- {result['name']}: {result['score']} ({result['interpretation']})" for result in metrics_results.values()])}

        –°–û–ó–î–ê–ô –ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó –í –°–¢–†–û–ì–û–ú –§–û–†–ú–ê–¢–ï –î–õ–Ø TELEGRAM:

        *1. –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞*
        [–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ 2-3 –∞–±–∑–∞—Ü–∞—Ö]

        *2. –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º –º–µ—Ç—Ä–∏–∫–∞–º*
        [–ê–Ω–∞–ª–∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –ª–∏–¥–µ—Ä—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∏ —Ç.–¥.]

        *3. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ 3]

        *4. –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è 3]

        *5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é*
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 1]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 2]
        ‚Ä¢ [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é 3]

        *6. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏*
        [–û—Ü–µ–Ω–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –≤ 1-2 –∞–±–∑–∞—Ü–∞—Ö]

        –í–ê–ñ–ù–û:
        - –ò—Å–ø–æ–ª—å–∑—É–π *—Ç–µ–∫—Å—Ç* –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∫—É—Ä—Å–∏–≤ –≤ Telegram)
        - –ò—Å–ø–æ–ª—å–∑—É–π ‚Ä¢ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ (–Ω–µ -, —Ç–∞–∫ –∫–∞–∫ - –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Telegram)
        - –ò—Å–ø–æ–ª—å–∑—É–π **—Ç–µ–∫—Å—Ç** –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ (–∂–∏—Ä–Ω—ã–π)
        - –ü–∏—à–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º HR-—è–∑—ã–∫–æ–º
        - –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞–π –≤—ã–≤–æ–¥—ã
        - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–µ—Ç–∫–æ–π –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º–æ–π –≤ Telegram
        """

        try:
            analysis = await self.ai_service.get_ai_response(prompt)
            return analysis
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI-–∞–Ω–∞–ª–∏–∑–∞: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."

    def calculate_overall_score(self, metrics_results: Dict) -> Dict:
        """–†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –±–∞–ª–ª–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        vip_scores = []
        regular_scores = []

        for metric_key, result in metrics_results.items():
            score = result["score"]

            # Ensure score is numeric
            try:
                score = float(score)
            except (ValueError, TypeError):
                logger.warning(f"Invalid score type for {metric_key}: {score} ({type(score)}), using default 1")
                score = 1

            metric_def = self.metrics_definitions[metric_key]

            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –±–∞–ª–ª—ã –∫ —à–∫–∞–ª–µ 0-100
            if metric_key == "professional_values":
                normalized_score = score
            elif metric_def["scale"][-1] == 5:
                normalized_score = (score - 1) / 4 * 100
            elif metric_def["scale"][-1] == 4:
                normalized_score = (score - 1) / 3 * 100
            else:  # scale 1-3
                normalized_score = (score - 1) / 2 * 100

            if metric_def.get("vip", False):
                vip_scores.append(normalized_score)
            else:
                regular_scores.append(normalized_score)

        # –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
        vip_avg = sum(vip_scores) / len(vip_scores) if vip_scores else 0
        regular_avg = sum(regular_scores) / len(regular_scores) if regular_scores else 0
        overall_score = (vip_avg * 0.7 + regular_avg * 0.3)  # VIP –º–µ—Ç—Ä–∏–∫–∏ –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if overall_score >= 80:
            category = "–û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å"
        elif overall_score >= 60:
            category = "–•–æ—Ä–æ—à–∏–π –ø—Ä–æ—Ñ–∏–ª—å"
        elif overall_score >= 40:
            category = "–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å"
        else:
            category = "–¢—Ä–µ–±—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏—è"

        return {
            "overall_score": round(overall_score, 1),
            "vip_average": round(vip_avg, 1),
            "regular_average": round(regular_avg, 1),
            "category": category
        }
